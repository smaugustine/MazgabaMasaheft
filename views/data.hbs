<article id="recordData">
  <script id="xmlDoc" type="text/xml">{{{xmlDoc}}}</script>
</article>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script>
  $(document).ready(function(){
    const xmlRequest = new XMLHttpRequest();
    const xsltProcessor = new XSLTProcessor();
    const domParser = new DOMParser();

    xmlRequest.open("GET", "/static/xsl/{{recordType}}/data.xsl", false);
    xmlRequest.send(null);
    const xslStylesheet = xmlRequest.responseXML;
    xsltProcessor.importStylesheet(xslStylesheet);

    const xmlDoc = domParser.parseFromString(document.getElementById('xmlDoc').innerHTML, "text/xml");
    
    $('#recordData').html(xsltProcessor.transformToFragment(xmlDoc, document));

    $.getJSON("/static/json/editors.json", function(editors){
      $('span[data-initials]').each(function(){
        $(this).text(editors[$(this).attr('data-initials')]);
      });
    });

    $('time').each(function(){
      $(this).text(
        (new Date($(this).attr('datetime')).toLocaleDateString())
      );
    });

    //https://api.zotero.org/groups/358366/items/?tag=bm:Grebaut1935LesanaSab&format=bib&v=3
    //https://api.zotero.org/groups/358366/items/?format=bib&v=3&tag=

    $('div[data-zotero]').each(function(){
      var tag = $(this).attr('data-zotero');
      $(this).load('https://api.zotero.org/groups/358366/items/?format=bib&v=3&tag='+tag);
    });

    $(document).on('click', 'a[data-toggle]', function(){
      var elemId = $(this).attr('data-toggle');
      $("*[data-for='"+elemId+"']").toggleClass('is-hidden');
      $(this).find('.icon').toggleClass('is-hidden');
    });

    $('a[href="./viewer"]').each(function(){
      if($('#recordMeta').is(':not([data-iiif]):not([data-images])')) $(this).addClass('has-text-grey').removeAttr('href');
      else if($('#recordMeta').is('[data-images]')) $(this).attr('href', $('#recordMeta').attr('data-images')).attr('target', '_blank');
    });
  });
</script>
